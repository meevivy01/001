name: JobThai Scraper Uni

# à¸à¸³à¸«à¸™à¸”à¹€à¸§à¸¥à¸²à¸—à¸³à¸‡à¸²à¸™
on:
  workflow_dispatch:      # 1. à¸›à¸¸à¹ˆà¸¡à¸à¸”à¸£à¸±à¸™à¹€à¸­à¸‡ (Manual Run)
  schedule:
    - cron: '0 17 * * *'   # 2. à¸£à¸±à¸™à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´à¸—à¸¸à¸à¸§à¸±à¸™à¸•à¸­à¸™ 00:00 à¸™. à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢ (UTC 17:00)

jobs:
  scrape_job:
    runs-on: ubuntu-latest
    
    # à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸² Timezone à¹ƒà¸«à¹‰à¹€à¸›à¹‡à¸™à¸›à¸£à¸°à¹€à¸—à¸¨à¹„à¸—à¸¢ (à¸ªà¸³à¸„à¸±à¸à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸²à¸£à¹€à¸Šà¹‡à¸„ Hot/New)
    env:
      TZ: 'Asia/Bangkok'

    steps:
      # 1. à¸”à¸¶à¸‡à¹‚à¸„à¹‰à¸”à¸¥à¹ˆà¸²à¸ªà¸¸à¸”à¸ˆà¸²à¸ GitHub à¸¡à¸²à¸§à¸²à¸‡à¸—à¸µà¹ˆ Server
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. à¸•à¸´à¸”à¸•à¸±à¹‰à¸‡ Google Chrome (à¹€à¸§à¸­à¸£à¹Œà¸Šà¸±à¹ˆà¸™à¸¥à¹ˆà¸²à¸ªà¸¸à¸”)
      - name: Install Google Chrome
        run: |
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable

      # 4. à¸¥à¸‡ Library à¸•à¸²à¸¡à¹„à¸Ÿà¸¥à¹Œ requirements.txt
      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          
      # 5. à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ Config à¹à¸¥à¸° .env (à¸”à¸¶à¸‡à¸„à¹ˆà¸²à¸ˆà¸²à¸ Secrets à¸¡à¸²à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¸ˆà¸£à¸´à¸‡)
      - name: Create Config & Env Files
        run: |
          # ðŸŸ¢ 1. à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œà¸„à¸§à¸²à¸¡à¸¥à¸±à¸šà¸šà¸£à¸´à¸©à¸±à¸—à¸ˆà¸²à¸ Secrets (à¹à¸—à¸™à¸à¸²à¸£ touch à¹„à¸Ÿà¸¥à¹Œà¹€à¸›à¸¥à¹ˆà¸²)
          echo "${{ secrets.COMPETITORS_DATA }}" > compe.yaml
          echo "${{ secrets.CLIENTS_DATA }}" > co.yaml
          echo "${{ secrets.TIER1_DATA }}" > tier1.yaml  # <-- à¹€à¸žà¸´à¹ˆà¸¡à¹„à¸Ÿà¸¥à¹Œ Tier 1
          
          # ðŸŸ¢ 2. à¸ªà¸£à¹‰à¸²à¸‡à¹„à¸Ÿà¸¥à¹Œ .env (à¹€à¸žà¸´à¹ˆà¸¡ Google Sheets Key)
          echo "JOBTHAI_USER=${{ secrets.JOBTHAI_USER }}" >> User.env
          echo "JOBTHAI_PASS=${{ secrets.JOBTHAI_PASS }}" >> User.env
          echo "EMAIL_SENDER=${{ secrets.EMAIL_SENDER }}" >> User.env
          echo "EMAIL_PASSWORD=${{ secrets.EMAIL_PASSWORD }}" >> User.env
          echo "EMAIL_RECEIVER=${{ secrets.EMAIL_RECEIVER }}" >> User.env
          echo "G_SHEET_KEY=${{ secrets.G_SHEET_KEY }}" >> User.env    # <-- à¹€à¸žà¸´à¹ˆà¸¡
          echo "G_SHEET_NAME=${{ secrets.G_SHEET_NAME }}" >> User.env  # <-- à¹€à¸žà¸´à¹ˆà¸¡

      # 6. à¸£à¸±à¸™à¹‚à¸„à¹‰à¸” Python
      - name: Run Scraper
        env:
          JOBTHAI_USER: ${{ secrets.JOBTHAI_USER }}
          JOBTHAI_PASS: ${{ secrets.JOBTHAI_PASS }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVER: ${{ secrets.EMAIL_RECEIVER }}
          COOKIES_JSON: ${{ secrets.COOKIES_JSON }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          
          # ðŸŸ¢ à¹€à¸žà¸´à¹ˆà¸¡ 2 à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰ (à¸ªà¹ˆà¸‡à¸„à¹ˆà¸²à¹„à¸›à¹ƒà¸«à¹‰ Python)
          G_SHEET_KEY: ${{ secrets.G_SHEET_KEY }}
          G_SHEET_NAME: ${{ secrets.G_SHEET_NAME }}
          
        run: python Git1.py

      # 7. à¹€à¸à¹‡à¸šà¹„à¸Ÿà¸¥à¹Œ CSV à¹à¸¥à¸°à¸£à¸¹à¸›à¸ à¸²à¸žà¸—à¸µà¹ˆà¹„à¸”à¹‰ à¸à¸¥à¸±à¸šà¸¡à¸²à¹ƒà¸«à¹‰à¹€à¸£à¸²à¸”à¸²à¸§à¸™à¹Œà¹‚à¸«à¸¥à¸”
      - name: Upload Results (CSV & Images)
        if: always() # à¸£à¸±à¸™à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™à¸™à¸µà¹‰à¹€à¸ªà¸¡à¸­ à¹à¸¡à¹‰à¹‚à¸›à¸£à¹à¸à¸£à¸¡à¸ˆà¸° Error à¸à¸¥à¸²à¸‡à¸—à¸²à¸‡
        uses: actions/upload-artifact@v4
        with:
          name: scraper-results
          path: |
            *.csv
            resume_images/
            *.png  <-- à¹€à¸žà¸´à¹ˆà¸¡à¸šà¸£à¸£à¸—à¸±à¸”à¸™à¸µà¹‰ (à¹€à¸žà¸·à¹ˆà¸­à¹€à¸à¹‡à¸šà¸£à¸¹à¸› Screenshot à¸•à¸­à¸™ Error)
          retention-days: 90
